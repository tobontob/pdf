{% extends "base.html" %}

{% block title %}변환{% endblock %}

{% block page_title %}
<h1 class="mb-3 text-primary">PDF 변환</h1>
{% endblock %}

{% block content %}
<div class="row justify-content-center mb-3">
    <div class="col-lg-8 text-center">
        <h2 class="mb-3">PDF 변환</h2>
        <p class="lead text-secondary">PDF 파일을 다양한 형식으로 변환하거나, 다른 형식의 파일을 PDF로 변환할 수 있습니다.</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">PDF에서 변환</h5>
            </div>
            <div class="card-body">
                <form id="pdfFromForm">
                    <div class="mb-4 file-upload" id="pdfDropZone">
                        <div class="upload-content">
                            <i class="ri-upload-cloud-line"></i>
                            <p class="mb-2">PDF 파일을 드래그하거나 클릭하여 업로드</p>
                            <button type="button" class="btn-upload">파일 선택</button>
                        </div>
                        <input type="file" name="pdf_file" accept=".pdf" class="file-input" required>
                        <div class="file-name-display"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">변환 형식 선택</label>
                        <select name="output_format" class="form-select" required>
                            <option value="">변환할 형식 선택...</option>
                            <option value="docx">Word (.docx)</option>
                            <option value="jpg">이미지 (.jpg)</option>
                            <option value="png">이미지 (.png)</option>
                        </select>
                    </div>
                    
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="ri-file-transfer-line me-1"></i>변환하기
                        </button>
                    </div>
                </form>
                
                <div id="fromPdfStatus" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">변환 중...</span>
                            </div>
                            <div>파일 변환 중...</div>
                        </div>
                    </div>
                </div>
                
                <div id="fromPdfError" class="mt-3" style="display: none;">
                    <div class="alert alert-danger">
                        <div class="error-message"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">PDF로 변환</h5>
            </div>
            <div class="card-body">
                <form id="pdfToForm">
                    <div class="mb-4 file-upload" id="fileDropZone">
                        <div class="upload-content">
                            <i class="ri-upload-cloud-line"></i>
                            <p class="mb-2">파일을 드래그하거나 클릭하여 업로드</p>
                            <p class="text-muted small">지원 형식: Word (.doc, .docx), 이미지 (.jpg, .jpeg, .png)</p>
                            <button type="button" class="btn-upload">파일 선택</button>
                        </div>
                        <input type="file" name="input_file" accept=".doc,.docx,.jpg,.jpeg,.png" class="file-input" required>
                        <div class="file-name-display"></div>
                    </div>
                    
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="ri-file-pdf-line me-1"></i>PDF로 변환
                        </button>
                    </div>
                </form>
                
                <div id="toPdfStatus" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">변환 중...</span>
                            </div>
                            <div>파일 변환 중...</div>
                        </div>
                    </div>
                </div>
                
                <div id="toPdfError" class="mt-3" style="display: none;">
                    <div class="alert alert-danger">
                        <div class="error-message"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // PDF에서 변환
    $('#pdfFromForm').on('submit', function(e) {
        e.preventDefault();
        console.log('폼 제출 시작');
        
        var formData = new FormData(this);
        $('#fromPdfStatus').show();
        $('#fromPdfError').hide();
        
        $.ajax({
            url: '/convert-from-pdf',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                console.log('변환 성공:', response);
                $('#fromPdfStatus').hide();
                if (response.success) {
                    window.location.href = response.download_url;
                    alert('변환이 완료되었습니다.');
                } else {
                    $('#fromPdfError').show().find('.error-message').text(response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('변환 오류:', error);
                $('#fromPdfStatus').hide();
                var errorMessage = '오류가 발생했습니다.';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMessage = response.message || errorMessage;
                } catch (e) {
                    errorMessage = '서버와의 통신 중 오류가 발생했습니다.';
                }
                $('#fromPdfError').show().find('.error-message').text(errorMessage);
            }
        });
    });
    
    // PDF로 변환
    $('#pdfToForm').on('submit', function(e) {
        e.preventDefault();
        console.log('폼 제출 시작');
        
        var formData = new FormData(this);
        $('#toPdfStatus').show();
        $('#toPdfError').hide();
        
        $.ajax({
            url: '/convert-to-pdf',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                console.log('변환 성공:', response);
                $('#toPdfStatus').hide();
                if (response.success) {
                    window.location.href = response.download_url;
                    alert('변환이 완료되었습니다.');
                } else {
                    $('#toPdfError').show().find('.error-message').text(response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('변환 오류:', error);
                $('#toPdfStatus').hide();
                var errorMessage = '오류가 발생했습니다.';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMessage = response.message || errorMessage;
                } catch (e) {
                    errorMessage = '서버와의 통신 중 오류가 발생했습니다.';
                }
                $('#toPdfError').show().find('.error-message').text(errorMessage);
            }
        });
    });
    
    // 파일 드래그 앤 드롭 처리
    $('.file-upload').each(function() {
        var $upload = $(this);
        var $input = $upload.find('.file-input');
        var $display = $upload.find('.file-name-display');
        
        $upload.on('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).addClass('dragover');
        });
        
        $upload.on('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('dragover');
        });
        
        $upload.on('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('dragover');
            
            var files = e.originalEvent.dataTransfer.files;
            $input[0].files = files;
            updateFileName($input, $display);
        });
        
        $upload.find('.btn-upload').on('click', function() {
            $input.click();
        });
        
        $input.on('change', function() {
            updateFileName($input, $display);
        });
    });
    
    function updateFileName($input, $display) {
        var fileName = $input[0].files[0] ? $input[0].files[0].name : '';
        if (fileName) {
            $display.text(fileName).show();
        } else {
            $display.text('').hide();
        }
    }
});
</script>
{% endblock %} 