<!DOCTYPE html>
{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">PDF 보안 설정</h1>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <!-- 파일 업로드 섹션 -->
                    <div class="mb-4">
                        <h5 class="mb-3">1. PDF 파일 업로드</h5>
                        <div class="drop-zone" id="dropZone">
                            <i class="bi bi-file-earmark-lock display-4 mb-3"></i>
                            <h5>PDF 파일을 드래그하거나 클릭하여 업로드</h5>
                            <p class="text-muted mb-0">지원 형식: .pdf</p>
                            <input type="file" id="fileInput" class="d-none" accept=".pdf">
                        </div>
                        <div id="fileInfo" class="mt-2 small text-muted"></div>
                    </div>
                    
                    <!-- 보안 옵션 -->
                    <div class="mb-4">
                        <h5 class="mb-3">2. 보안 옵션 선택</h5>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="securityAction" id="addPassword" value="add" checked>
                                <label class="form-check-label" for="addPassword">
                                    비밀번호 추가/변경
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="securityAction" id="removePassword" value="remove">
                                <label class="form-check-label" for="removePassword">
                                    비밀번호 제거
                                </label>
                            </div>
                        </div>
                        
                        <!-- 비밀번호 설정 필드 (비밀번호 추가/변경 시에만 표시) -->
                        <div id="passwordFields">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="password" class="form-label">비밀번호</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="password" placeholder="비밀번호 입력">
                                        <button class="btn btn-outline-secondary toggle-password" type="button">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">PDF를 열기 위한 비밀번호입니다.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="confirmPassword" class="form-label">비밀번호 확인</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="confirmPassword" placeholder="비밀번호 다시 입력">
                                        <button class="btn btn-outline-secondary toggle-password" type="button">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="restrictPrinting" checked>
                                        <label class="form-check-label" for="restrictPrinting">
                                            인쇄 제한
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="restrictCopy" checked>
                                        <label class="form-check-label" for="restrictCopy">
                                            복사 및 추출 제한
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="restrictModify" checked>
                                        <label class="form-check-label" for="restrictModify">
                                            문서 수정 제한
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 기존 비밀번호 필드 (비밀번호 제거 시에만 표시) -->
                        <div id="currentPasswordField" class="d-none">
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">현재 비밀번호</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="currentPassword" placeholder="현재 비밀번호 입력">
                                    <button class="btn btn-outline-secondary toggle-password" type="button">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">비밀번호를 제거하려면 현재 비밀번호가 필요합니다.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 변환 버튼 -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="processBtn" disabled>
                            <i class="bi bi-shield-lock me-2"></i>처리하기
                        </button>
                    </div>
                    
                    <!-- 상태 메시지 -->
                    <div class="alert mt-3 d-none" id="statusMessage"></div>
                    
                    <!-- 다운로드 버튼 -->
                    <a href="#" class="btn btn-success w-100 mt-3 d-none" id="downloadBtn">
                        <i class="bi bi-download me-2"></i>보안 처리된 파일 다운로드
                    </a>
                </div>
            </div>
            
            <!-- 도움말 섹션 -->
            <div class="card mt-4 border-0 bg-light">
                <div class="card-body">
                    <h5 class="card-title">도움말</h5>
                    <ul class="mb-0">
                        <li>비밀번호를 추가하거나 제거하여 PDF 파일을 보호할 수 있습니다.</li>
                        <li>비밀번호는 대소문자를 구분하며, 안전을 위해 강력한 비밀번호를 사용하세요.</li>
                        <li>비밀번호를 분실한 경우 복구할 수 없으니 주의해주세요.</li>
                        <li>인쇄, 복사, 수정 제한은 일부 PDF 뷰어에서만 지원될 수 있습니다.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusMessage = document.getElementById('statusMessage');
    const passwordFields = document.getElementById('passwordFields');
    const currentPasswordField = document.getElementById('currentPasswordField');
    const securityActionRadios = document.getElementsByName('securityAction');
    const togglePasswordBtns = document.querySelectorAll('.toggle-password');
    
    let selectedFile = null;
    
    // 보안 옵션 변경 이벤트
    securityActionRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'add') {
                passwordFields.classList.remove('d-none');
                currentPasswordField.classList.add('d-none');
            } else {
                passwordFields.classList.add('d-none');
                currentPasswordField.classList.remove('d-none');
            }
        });
    });
    
    // 비밀번호 보기/숨기기 토글
    togglePasswordBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const input = this.previousElementSibling;
            const icon = this.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });
    });
    
    // 드래그 앤 드롭 이벤트 처리
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropZone.classList.add('border-primary', 'bg-light');
    }
    
    function unhighlight() {
        dropZone.classList.remove('border-primary', 'bg-light');
    }
    
    // 파일 선택 처리
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFileSelect);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            handleFiles(files);
        }
    }
    
    function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            handleFiles(files);
        }
    }
    
    function handleFiles(files) {
        const file = files[0];
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            showAlert('PDF 파일만 업로드할 수 있습니다.', 'danger');
            return;
        }
        
        selectedFile = file;
        updateFileInfo(file.name, file.size);
        processBtn.disabled = false;
        
        // 다운로드 버튼과 상태 메시지 초기화
        downloadBtn.classList.add('d-none');
        statusMessage.classList.add('d-none');
    }
    
    // 파일 정보 업데이트
    function updateFileInfo(name, size) {
        fileInfo.innerHTML = `
            <i class="bi bi-check-circle-fill text-success me-1"></i>
            ${name} (${formatFileSize(size)})
        `;
    }
    
    // 파일 크기 포맷팅
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // 알림 표시
    function showAlert(message, type) {
        statusMessage.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        statusMessage.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        statusMessage.classList.remove('d-none');
    }
    
    // 처리 버튼 클릭
    processBtn.addEventListener('click', function() {
        if (!selectedFile) return;
        
        const securityAction = document.querySelector('input[name="securityAction"]:checked').value;
        let password = '';
        let currentPassword = '';
        
        // 유효성 검사
        if (securityAction === 'add') {
            password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!password) {
                showAlert('비밀번호를 입력해주세요.', 'warning');
                return;
            }
            
            if (password !== confirmPassword) {
                showAlert('비밀번호가 일치하지 않습니다.', 'warning');
                return;
            }
            
            if (password.length < 4) {
                showAlert('비밀번호는 최소 4자 이상이어야 합니다.', 'warning');
                return;
            }
        } else {
            currentPassword = document.getElementById('currentPassword').value;
            
            if (!currentPassword) {
                showAlert('현재 비밀번호를 입력해주세요.', 'warning');
                return;
            }
        }
        
        // 폼 데이터 생성
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('action', securityAction);
        
        if (securityAction === 'add') {
            formData.append('password', password);
            formData.append('restrictPrinting', document.getElementById('restrictPrinting').checked);
            formData.append('restrictCopy', document.getElementById('restrictCopy').checked);
            formData.append('restrictModify', document.getElementById('restrictModify').checked);
        } else {
            formData.append('currentPassword', currentPassword);
        }
        
        // 로딩 상태 표시
        const originalText = processBtn.innerHTML;
        processBtn.disabled = true;
        processBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            처리 중...
        `;
        
        // 서버에 요청 전송
        fetch('/process-pdf-security', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || '처리 중 오류가 발생했습니다.');
                });
            }
            return response.blob();
        })
        .then(blob => {
            // 다운로드 링크 생성
            const url = window.URL.createObjectURL(blob);
            downloadBtn.href = url;
            downloadBtn.download = `secured_${selectedFile.name}`;
            downloadBtn.classList.remove('d-none');
            
            // 성공 메시지 표시
            showAlert(
                securityAction === 'add' 
                    ? 'PDF에 비밀번호가 성공적으로 설정되었습니다.' 
                    : 'PDF에서 비밀번호가 성공적으로 제거되었습니다.', 
                'success'
            );
            
            // 스크롤 다운로드 버튼으로 이동
            downloadBtn.scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('처리 중 오류가 발생했습니다: ' + error.message, 'danger');
        })
        .finally(() => {
            processBtn.disabled = false;
            processBtn.innerHTML = originalText;
        });
    });
    
    // 다운로드 후 메모리 정리
    downloadBtn.addEventListener('click', function() {
        // 다운로드 후 일정 시간 후에 URL 해제
        setTimeout(() => {
            if (this.href.startsWith('blob:')) {
                window.URL.revokeObjectURL(this.href);
            }
        }, 100);
    });
});
</script>
{% endblock %}
